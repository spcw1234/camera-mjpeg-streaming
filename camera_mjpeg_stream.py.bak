#!/usr/bin/env python3
"""
ğŸš€ MJPEG HTTP ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹
- GStreamer RTSP ëŒ€ì‹  HTTP MJPEG ì‚¬ìš©
- í›¨ì”¬ ê°„ë‹¨í•˜ê³  ë¹ ë¥¸ ìŠ¤íŠ¸ë¦¬ë°
- ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ë³¼ ìˆ˜ ìˆìŒ
"""

import cv2
import threading
import time
import numpy as np
from http.server import BaseHTTPRequestHandler, HTTPServer
from socketserver import ThreadingMixIn
import traceback
from rknnlite.api import RKNNLite as RKNN

def find_working_camera():
    """ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ ì°¾ê¸°"""
    for i in range(12):
        device = f'/dev/video{i}'
        try:
            cap = cv2.VideoCapture(device)
            if cap.isOpened():
                ret, frame = cap.read()
                cap.release()
                if ret and frame is not None:
                    print(f"âœ“ ì¹´ë©”ë¼ ë°œê²¬: {device}")
                    return device
        except:
            continue
    raise Exception("ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

class MJPEGStreamHandler(BaseHTTPRequestHandler):
    """MJPEG ìŠ¤íŠ¸ë¦¼ í•¸ë“¤ëŸ¬"""
    
    def do_GET(self):
        if self.path == '/':
            self.send_html_page()
        elif self.path == '/stream':
            self.send_mjpeg_stream()
        else:
            self.send_error(404)
    
    def send_html_page(self):
        """HTML ë·°ì–´ í˜ì´ì§€"""
        html = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>ğŸš€ ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼</title>
            <style>
                body { background: #000; color: #fff; text-align: center; font-family: Arial; }
                img { max-width: 90%; height: auto; border: 2px solid #0f0; }
                h1 { color: #0f0; }
            </style>
        </head>
        <body>
            <h1>ğŸš€ ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼</h1>
            <img src="/stream" alt="Camera Stream">
            <p>ì‹¤ì‹œê°„ MJPEG ìŠ¤íŠ¸ë¦¬ë°</p>
        </body>
        </html>
        """
        self.send_response(200)
        self.send_header('Content-Type', 'text/html')
        self.end_headers()
        self.wfile.write(html.encode())
    
    def send_mjpeg_stream(self):
        """MJPEG ìŠ¤íŠ¸ë¦¼ ì „ì†¡"""
        self.send_response(200)
        self.send_header('Content-Type', 'multipart/x-mixed-replace; boundary=frame')
        self.send_header('Cache-Control', 'no-cache')
        self.end_headers()
        
        try:
            while True:
                if hasattr(self.server, 'current_frame') and self.server.current_frame is not None:
                    # JPEG ì¸ì½”ë”©
                    ret, jpeg = cv2.imencode('.jpg', self.server.current_frame, 
                                           [cv2.IMWRITE_JPEG_QUALITY, 85])
                    if ret:
                        # MJPEG í”„ë ˆì„ ì „ì†¡
                        self.wfile.write(b'--frame\r\n')
                        self.wfile.write(b'Content-Type: image/jpeg\r\n\r\n')
                        self.wfile.write(jpeg.tobytes())
                        self.wfile.write(b'\r\n')
                
                time.sleep(0.033)  # ~30 FPS
        except Exception as e:
            print(f"ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜: {e}")

class ThreadedHTTPServer(ThreadingMixIn, HTTPServer):
    """ë©€í‹°ìŠ¤ë ˆë“œ HTTP ì„œë²„"""
    allow_reuse_address = True
    current_frame = None

class FastRKNNDetector:
    """ë¹ ë¥¸ RKNN ë””í…í„°"""
    def __init__(self, model_path='/home/spcwtech/yolo5n_fish-rk3566.rknn'):
        print("ğŸš€ ë¹ ë¥¸ RKNN ë””í…í„° ì´ˆê¸°í™”...")
        
        self.rknn = RKNN()
        ret = self.rknn.load_rknn(model_path)
        if ret != 0:
            raise Exception('RKNN ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨')
        
        ret = self.rknn.init_runtime()
        if ret != 0:
            raise Exception('RKNN ëŸ°íƒ€ì„ ì´ˆê¸°í™” ì‹¤íŒ¨')
        
        self.input_size = 640
        
        # ì„±ëŠ¥ ìµœì í™” ì„¤ì •
        self.frame_skip = 2  # ë§¤ 2ë²ˆì§¸ í”„ë ˆì„ë§Œ ì²˜ë¦¬
        self.frame_counter = 0
        self.last_detections = []
        
        print("âœ“ ë¹ ë¥¸ ë””í…í„° ì´ˆê¸°í™” ì™„ë£Œ")
    
    def letterbox(self, img, new_shape=(640, 640)):
        """ë¹ ë¥¸ ë¦¬ì‚¬ì´ì¦ˆ"""
        return cv2.resize(img, new_shape)
    
    def detect(self, frame):
        """ë¹ ë¥¸ ê°ì§€"""
        try:
            # í”„ë ˆì„ ìŠ¤í‚µ
            self.frame_counter += 1
            if self.frame_counter % self.frame_skip != 0:
                return self.draw_cached_detections(frame)
            
            # ì „ì²˜ë¦¬
            input_frame = self.letterbox(frame, (self.input_size, self.input_size))
            input_frame = np.expand_dims(input_frame, axis=0)
            
            # RKNN ì¶”ë¡ 
            outputs = self.rknn.inference(inputs=[input_frame])
            
            # ê°„ë‹¨í•œ í›„ì²˜ë¦¬
            detections = self.decode_predictions(outputs)
            self.last_detections = detections
            
            return self.draw_detections(frame, detections)
            
        except Exception as e:
            return frame
    
    def decode_predictions(self, outputs, conf_thres=0.5):
        """ê°„ë‹¨í•œ ë””ì½”ë”©"""
        predictions = []
        try:
            for detection in outputs[0]:
                if len(detection) >= 6:
                    confidence = float(detection[4])
                    if confidence > conf_thres:
                        x, y, w, h = detection[:4]
                        class_id = int(detection[5])
                        predictions.append([x, y, w, h, confidence, class_id])
        except:
            pass
        return predictions
    
    def draw_cached_detections(self, frame):
        """ìºì‹œëœ ê°ì§€ ê²°ê³¼ ê·¸ë¦¬ê¸°"""
        return self.draw_detections(frame, self.last_detections)
    
    def draw_detections(self, frame, detections):
        """ê°„ë‹¨í•œ ê°ì§€ ê²°ê³¼ ê·¸ë¦¬ê¸°"""
        for det in detections:
            try:
                x, y, w, h, conf, class_id = det
                x1 = int(x - w/2)
                y1 = int(y - h/2)
                x2 = int(x + w/2)
                y2 = int(y + h/2)
                
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                cv2.putText(frame, f'{conf:.2f}', (x1, y1-10), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)
            except:
                continue
        
        return frame

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print("ğŸš€ MJPEG HTTP ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘")
    
    cap = None
    detector = None
    server = None
    
    try:
        # ì¹´ë©”ë¼ ì´ˆê¸°í™”
        video_device = find_working_camera()
        cap = cv2.VideoCapture(video_device)
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
        cap.set(cv2.CAP_PROP_FPS, 30)
        cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
        
        if not cap.isOpened():
            raise Exception("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        print("âœ“ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ")
        
        # ë””í…í„° ì´ˆê¸°í™”
        detector = FastRKNNDetector()
        
        # HTTP ì„œë²„ ì‹œì‘
        server = ThreadedHTTPServer(('0.0.0.0', 8080), MJPEGStreamHandler)
        server_thread = threading.Thread(target=server.serve_forever, daemon=True)
        server_thread.start()
        
        print("âœ… HTTP ì„œë²„ ì‹œì‘ë¨:")
        print(f"   ğŸŒ ë¡œì»¬: http://localhost:8080")
        print(f"   ğŸŒ ì™¸ë¶€: http://spcwtech.mooo.com:8080")
        print(f"   ğŸ¥ ìŠ¤íŠ¸ë¦¼: http://spcwtech.mooo.com:8080/stream")
        print("\nğŸš€ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")
        
        frame_count = 0
        start_time = time.time()
        
        while True:
            ret, frame = cap.read()
            if not ret:
                time.sleep(0.01)
                continue
            
            # ê°ì§€ ì²˜ë¦¬
            processed_frame = detector.detect(frame)
            
            # FPS ì •ë³´ ì¶”ê°€
            frame_count += 1
            if frame_count % 30 == 0:
                elapsed = time.time() - start_time
                fps = frame_count / elapsed
                print(f"ğŸš€ FPS: {fps:.1f}")
                start_time = time.time()
                frame_count = 0
            
            # ì„œë²„ì— í”„ë ˆì„ ì„¤ì •
            server.current_frame = processed_frame
            
            time.sleep(0.01)  # CPU ì‚¬ìš©ëŸ‰ ì¡°ì ˆ
    
    except KeyboardInterrupt:
        print("\nì¢…ë£Œ ì‹ í˜¸ ë°›ìŒ...")
    except Exception as e:
        print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc()
    finally:
        print("ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘...")
        
        if cap and cap.isOpened():
            cap.release()
            print("âœ“ ì¹´ë©”ë¼ í•´ì œ")
        
        if server:
            server.shutdown()
            print("âœ“ HTTP ì„œë²„ ì¢…ë£Œ")
        
        if detector:
            try:
                detector.rknn.release()
            except:
                pass
            print("âœ“ ë””í…í„° ì •ë¦¬")
        
        print("âœ… MJPEG ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ì™„ë£Œ")

if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print(f"ë©”ì¸ í•¨ìˆ˜ ì˜¤ë¥˜: {e}")
        traceback.print_exc()
