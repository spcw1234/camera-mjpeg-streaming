#!/usr/bin/env python3
"""
ìµœì í™”ëœ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° í”„ë¡œê·¸ë¨
- DeepSORT ë¹„í™œì„±í™”ë¡œ ì„±ëŠ¥ í–¥ìƒ
- í”„ë ˆì„ ìŠ¤í‚µ ê¸°ëŠ¥ ì¶”ê°€
- ê²½ëŸ‰í™”ëœ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
"""

import cv2
import gi
import os
import serial
import threading
import sys
import termios
import tty
import time
import select
import numpy as np
import json
import uuid
import traceback
import paho.mqtt.client as mqtt
import hashlib
import subprocess
import time
from pynput import keyboard
from rknnlite.api import RKNNLite as RKNN

gi.require_version('Gst', '1.0')
gi.require_version('GstRtspServer', '1.0')
from gi.repository import Gst, GstRtspServer, GLib

def test_camera_device(device_path):
    """Test if a camera device is working"""
    try:
        cap = cv2.VideoCapture(device_path)
        if not cap.isOpened():
            return False
        ret, frame = cap.read()
        cap.release()
        return ret and frame is not None
    except:
        return False

class GStreamerRTSPServer:
    def __init__(self, port=7200, mount_point="/test"):
        """GStreamer RTSP ì„œë²„ ì´ˆê¸°í™” - ì„±ëŠ¥ ìµœì í™” ë²„ì „"""
        self.port = port
        self.mount_point = mount_point
        self.server = None
        self.factory = None
        self.mainloop = None
        self.running = False
        self.appsrc = None
        self.need_data = True
        self.clients_connected = 0
        self.frame_count = 0
        
        # GStreamer ì´ˆê¸°í™”
        if not Gst.is_initialized():
            Gst.init(None)
        
        print(f"ìµœì í™”ëœ RTSP ì„œë²„ ì´ˆê¸°í™” - Port: {port}, Mount: {mount_point}")
    
    def create_pipeline(self):
        """ì„±ëŠ¥ ìµœì í™”ëœ íŒŒì´í”„ë¼ì¸ - ë” ë¹ ë¥¸ ì¸ì½”ë”© ì„¤ì •"""
        pipeline_str = (
            "( appsrc name=source is-live=true block=false format=GST_FORMAT_TIME "
            "caps=video/x-raw,format=BGRx,width=640,height=640,framerate=10/1 ! "
            "videoconvert ! video/x-raw,format=I420 ! "
            "x264enc speed-preset=superfast tune=zerolatency bitrate=1000 threads=2 "
            "key-int-max=10 bframes=0 ! "
            "rtph264pay config-interval=1 name=pay0 pt=96 )"
        )
        return pipeline_str
    
    def start_server(self):
        """RTSP ì„œë²„ ì‹œì‘"""
        try:
            self.server = GstRtspServer.RTSPServer()
            self.server.set_service(str(self.port))
            
            self.factory = GstRtspServer.RTSPMediaFactory()
            self.factory.set_launch(self.create_pipeline())
            self.factory.set_shared(True)
            
            # ë¯¸ë””ì–´ íŒ©í† ë¦¬ì— ì½œë°± ì—°ê²°
            self.factory.connect("media-configure", self.on_media_configure)
            
            mount_points = self.server.get_mount_points()
            mount_points.add_factory(self.mount_point, self.factory)
            
            self.server.attach(None)
            
            # GLib ë©”ì¸ ë£¨í”„ë¥¼ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
            self.start_glib_loop()
            
            self.running = True
            
            print(f"ìµœì í™”ëœ RTSP ì„œë²„ ì‹œì‘ë¨ - rtsp://spcwtech.mooo.com:{self.port}{self.mount_point}")
            return True
            
        except Exception as e:
            print(f"RTSP ì„œë²„ ì‹œì‘ ì‹¤íŒ¨: {e}")
            traceback.print_exc()
            return False
    
    def start_glib_loop(self):
        """GLib ë©”ì¸ ë£¨í”„ë¥¼ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹œì‘"""
        def glib_loop():
            try:
                context = GLib.MainContext.new()
                GLib.MainContext.push_thread_default(context)
                
                self.mainloop = GLib.MainLoop.new(context, False)
                self.mainloop.run()
            except Exception as e:
                print(f"GLib ë©”ì¸ ë£¨í”„ ì˜¤ë¥˜: {e}")
            finally:
                try:
                    GLib.MainContext.pop_thread_default()
                except:
                    pass
        
        import threading
        self.glib_thread = threading.Thread(target=glib_loop, daemon=True)
        self.glib_thread.start()
    
    def on_media_configure(self, factory, media):
        """ë¯¸ë””ì–´ê°€ êµ¬ì„±ë  ë•Œ í˜¸ì¶œë˜ëŠ” ì½œë°±"""
        try:
            element = media.get_element()
            if element:
                self.appsrc = element.get_by_name("source")
                if self.appsrc:
                    # ìµœì í™”ëœ appsrc ì„¤ì •
                    self.appsrc.set_property("is-live", True)
                    self.appsrc.set_property("block", False)  # non-blockingìœ¼ë¡œ ë³€ê²½
                    self.appsrc.set_property("format", Gst.Format.TIME)
                    self.appsrc.set_property("emit-signals", True)
                    
                    # ë²„í¼ í¬ê¸° ìµœì í™”
                    self.appsrc.set_property("max-bytes", 1000000)  # 1MB
                    self.appsrc.set_property("drop", True)  # í”„ë ˆì„ ë“œë¡­ í—ˆìš©
                    
                    # ì‹ í˜¸ ì—°ê²°
                    self.appsrc.connect("need-data", self.on_need_data)
                    self.appsrc.connect("enough-data", self.on_enough_data)
                    
                    # ë‚®ì€ í”„ë ˆì„ë ˆì´íŠ¸ë¡œ caps ì„¤ì •
                    caps = Gst.Caps.from_string("video/x-raw,format=BGRx,width=640,height=640,framerate=10/1")
                    self.appsrc.set_property("caps", caps)
                    
                    self.clients_connected += 1
                    print(f"í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨ (ì´ {self.clients_connected}ê°œ)")
        except Exception as e:
            print(f"ë¯¸ë””ì–´ êµ¬ì„± ì˜¤ë¥˜: {e}")
    
    def on_need_data(self, src, length):
        """ë°ì´í„°ê°€ í•„ìš”í•  ë•Œ í˜¸ì¶œ"""
        self.need_data = True
        
    def on_enough_data(self, src):
        """ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìˆì„ ë•Œ í˜¸ì¶œ"""
        self.need_data = False
    
    def push_frame(self, frame):
        """í”„ë ˆì„ í‘¸ì‹œ - ì„±ëŠ¥ ìµœì í™”"""
        try:
            if not self.running or self.appsrc is None:
                return False

            if frame is None:
                return False

            # í”„ë ˆì„ ìŠ¤í‚µ ë¡œì§ (ë§¤ 2ë²ˆì§¸ í”„ë ˆì„ë§Œ ì „ì†¡)
            self.frame_count += 1
            if self.frame_count % 2 != 0:
                return True  # í”„ë ˆì„ ìŠ¤í‚µ

            # BGRx ë³€í™˜ (ë” ë¹ ë¥¸ ë°©ë²•)
            if frame.shape[2] == 3:  # BGR
                frame_bgrx = cv2.cvtColor(frame, cv2.COLOR_BGR2BGRA)
            else:
                frame_bgrx = frame
                
            data = frame_bgrx.tobytes()
            buf = Gst.Buffer.new_allocate(None, len(data), None)
            buf.fill(0, data)
            
            # ê°„ë‹¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„
            if not hasattr(self, 'pts'):
                self.pts = 0
                self.duration = Gst.SECOND // 10  # 10 FPS
            
            buf.pts = self.pts
            buf.duration = self.duration
            self.pts += self.duration

            # non-blocking í‘¸ì‹œ
            retval = self.appsrc.emit('push-buffer', buf)
            return retval == Gst.FlowReturn.OK
                
        except Exception as e:
            print(f"í”„ë ˆì„ í‘¸ì‹œ ì˜¤ë¥˜: {e}")
            return False
    
    def stop_server(self):
        """RTSP ì„œë²„ ì¤‘ì§€"""
        if self.running:
            self.running = False
            print("RTSP ì„œë²„ ì¤‘ì§€ ì¤‘...")
            
            if self.appsrc:
                try:
                    self.appsrc.emit("end-of-stream")
                except Exception as e:
                    pass
            
            if self.mainloop:
                try:
                    def quit_mainloop():
                        self.mainloop.quit()
                        return False
                    
                    GLib.idle_add(quit_mainloop)
                    
                    if hasattr(self, 'glib_thread') and self.glib_thread.is_alive():
                        self.glib_thread.join(timeout=2.0)
                        
                except Exception as e:
                    pass
                    
            print("RTSP ì„œë²„ ì¤‘ì§€ ì™„ë£Œ")
    
    def get_rtsp_url(self):
        """RTSP URL ë°˜í™˜"""
        return f"rtsp://spcwtech.mooo.com:{self.port}{self.mount_point}"

class OptimizedRKNNDetector:
    def __init__(self, model_path='/home/spcwtech/yolo5n_fish-rk3566.rknn'):
        """ìµœì í™”ëœ RKNN ë””í…í„° - DeepSORT ì—†ì´ ë¹ ë¥¸ ì²˜ë¦¬"""
        self.rknn = RKNN()
        try:
            ret = self.rknn.load_rknn(model_path)
            if ret != 0:
                print('RKNN ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨')
                exit(ret)
                
            ret = self.rknn.init_runtime()
            if ret != 0:
                print('RKNN ëŸ°íƒ€ì„ ì´ˆê¸°í™” ì‹¤íŒ¨')
                exit(ret)
        except Exception as e:
            print(f"RKNN ì´ˆê¸°í™” ì˜¤ë¥˜: {e}")
            traceback.print_exc()
            
        self.input_size = 640
        
        # í´ë˜ìŠ¤ ì´ë¦„ ë¡œë“œ
        try:
            with open("coco.names", "r") as f:
                self.classes = [line.strip() for line in f.readlines()]
        except FileNotFoundError:
            self.classes = [f"class_{i}" for i in range(80)]

        # ì„±ëŠ¥ ì¸¡ì •ìš©
        self.frame_count = 0
        self.skip_frames = 2  # ë§¤ 2í”„ë ˆì„ë§ˆë‹¤ ì²˜ë¦¬
        self.last_detection_time = time.time()
        
        print("ìµœì í™”ëœ RKNN ë””í…í„° ì´ˆê¸°í™” ì™„ë£Œ (DeepSORT ë¹„í™œì„±í™”)")

    def letterbox(self, img, new_shape=(640, 640), color=(114, 114, 114)):
        """ë¹ ë¥¸ letterbox ë³€í™˜"""
        shape = img.shape[:2]
        r = min(new_shape[0] / shape[0], new_shape[1] / shape[1])
        
        new_unpad = int(round(shape[1] * r)), int(round(shape[0] * r))
        dw, dh = new_shape[1] - new_unpad[0], new_shape[0] - new_unpad[1]
        dw /= 2
        dh /= 2
        
        if shape[::-1] != new_unpad:
            img = cv2.resize(img, new_unpad, interpolation=cv2.INTER_LINEAR)
            
        top, bottom = int(round(dh - 0.1)), int(round(dh + 0.1))
        left, right = int(round(dw - 0.1)), int(round(dw + 0.1))
        
        img = cv2.copyMakeBorder(img, top, bottom, left, right, cv2.BORDER_CONSTANT, value=color)
        return img, r, (dw, dh)

    def decode_predictions(self, output, conf_thres=0.3, max_score=0.95):
        """ë¹ ë¥¸ ë””ì½”ë”© - ì‹ ë¢°ë„ ì„ê³„ê°’ ë†’ì„"""
        try:
            pred = output[0].squeeze().transpose(1, 0)
            boxes_raw = pred[:, :4]
            objectness = pred[:, 4] * 10
            class_probs = pred[:, 5:] * 2
            class_conf = np.max(class_probs, axis=1)
            class_ids = np.argmax(class_probs, axis=1)
            scores = objectness + class_conf 
            
            # ë” ë†’ì€ ì„ê³„ê°’ìœ¼ë¡œ í•„í„°ë§
            mask = (scores > conf_thres) & (scores <= max_score)
            boxes_xywh = boxes_raw[mask]
            scores_filtered = scores[mask]
            class_ids_filtered = class_ids[mask]
            
            if len(boxes_xywh) == 0:
                return np.array([])
            
            detections = np.column_stack([
                boxes_xywh,
                scores_filtered,
                class_ids_filtered
            ])
            
            return detections
        except Exception as e:
            return np.array([])

    def apply_nms(self, detections, iou_thres=0.45):
        """ë¹ ë¥¸ NMS"""
        try:
            if len(detections) == 0:
                return []
            
            boxes = detections[:, :4]
            scores = detections[:, 4]
            
            indices = cv2.dnn.NMSBoxes(
                boxes.tolist(), 
                scores.tolist(), 
                score_threshold=0.4,  # ë” ë†’ì€ ì„ê³„ê°’
                nms_threshold=iou_thres
            )
            
            if len(indices) == 0:
                return []
            
            if isinstance(indices, tuple):
                indices = indices[0]
            else:
                indices = indices.flatten()
                
            return detections[indices]
        except Exception as e:
            return []

    def detect(self, frame):
        """ìµœì í™”ëœ ê°ì§€ - í”„ë ˆì„ ìŠ¤í‚µê³¼ ê°„ë‹¨í•œ ì²˜ë¦¬"""
        try:
            if frame is None:
                return frame

            # í”„ë ˆì„ ìŠ¤í‚µ ë¡œì§
            self.frame_count += 1
            draw_frame = frame.copy()
            
            # ë§¤ Në²ˆì§¸ í”„ë ˆì„ë§Œ ì²˜ë¦¬
            if self.frame_count % self.skip_frames != 0:
                return draw_frame

            start_time = time.time()
            
            # 1. ì „ì²˜ë¦¬
            img, ratio, pad = self.letterbox(frame, new_shape=(self.input_size, self.input_size))
            img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
            img = np.expand_dims(img, axis=0)

            # 2. RKNN ì¶”ë¡ 
            try:
                outputs = self.rknn.inference(inputs=[img])
            except Exception as e:
                return draw_frame

            # 3. í›„ì²˜ë¦¬ (ë¹ ë¥¸ ë²„ì „)
            detections = self.decode_predictions(outputs, conf_thres=0.3, max_score=0.95)
            detections = self.apply_nms(detections, iou_thres=0.45)
            
            # 4. ê²°ê³¼ ê·¸ë¦¬ê¸° (ê°„ë‹¨í•˜ê²Œ)
            for det in detections:
                x, y, w, h, score, class_id = det
                class_id = int(class_id)
                
                # ì¢Œí‘œ ë³€í™˜
                x = (x - pad[0]) / ratio
                y = (y - pad[1]) / ratio
                w = w / ratio
                h = h / ratio
                
                x1 = int(max(0, x - w/2))
                y1 = int(max(0, y - h/2))
                x2 = int(min(frame.shape[1]-1, x + w/2))
                y2 = int(min(frame.shape[0]-1, y + h/2))

                if (x2-x1 < 5) or (y2-y1 < 5):
                    continue

                # ê°„ë‹¨í•œ ë°•ìŠ¤ì™€ ë¼ë²¨ë§Œ ê·¸ë¦¬ê¸°
                class_name = self.classes[class_id] if class_id < len(self.classes) else f"class_{class_id}"
                color = (0, 255, 0)
                cv2.rectangle(draw_frame, (x1, y1), (x2, y2), color, 2)
                
                label = f"{class_name}: {score:.2f}"
                cv2.putText(draw_frame, label, (x1, y1-10), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 1)
            
            processing_time = time.time() - start_time
            
            # ì„±ëŠ¥ ì •ë³´ í‘œì‹œ
            fps = 1.0 / processing_time if processing_time > 0 else 0
            cv2.putText(draw_frame, f"Process FPS: {fps:.1f}", (10, 30), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 255), 2)
            cv2.putText(draw_frame, f"Process Time: {processing_time*1000:.1f}ms", (10, 60), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 0), 1)
            cv2.putText(draw_frame, f"Objects: {len(detections)}", (10, 90), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 0, 255), 1)
            
            # ì„±ëŠ¥ ë¡œê·¸ (10í”„ë ˆì„ë§ˆë‹¤)
            if self.frame_count % 20 == 0:
                actual_fps = 1.0 / processing_time if processing_time > 0 else 0
                print(f"ğŸš€ ìµœì í™”ëœ ì²˜ë¦¬ - FPS: {actual_fps:.1f}, ì²˜ë¦¬ì‹œê°„: {processing_time*1000:.1f}ms, ê°ì²´: {len(detections)}ê°œ")
                
                if processing_time > 0.2:  # 200ms ì´ˆê³¼ì‹œ
                    print(f"âš ï¸  ì—¬ì „íˆ ëŠë¦¼: {processing_time*1000:.1f}ms")
                elif processing_time < 0.05:  # 50ms ë¯¸ë§Œì‹œ
                    print(f"âœ… ì„±ëŠ¥ ì–‘í˜¸: {processing_time*1000:.1f}ms")
            
            return draw_frame

        except Exception as e:
            print(f"ê°ì§€ ì˜¤ë¥˜: {e}")
            return frame

def find_working_camera():
    """Find the first working video device"""
    for i in range(12):
        device = f'/dev/video{i}'
        if test_camera_device(device):
            print(f"âœ“ ì¹´ë©”ë¼ ë°œê²¬: {device}")
            return device
    
    raise Exception("ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

def main():
    """ìµœì í™”ëœ ë©”ì¸ í•¨ìˆ˜"""
    print("=== ìµœì í™”ëœ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ===")
    print("- DeepSORT ë¹„í™œì„±í™”")
    print("- í”„ë ˆì„ ìŠ¤í‚µ í™œì„±í™”")
    print("- ë¹ ë¥¸ ì¸ì½”ë”© ì„¤ì •")
    
    cap = None
    detector = None
    gst_server = None
    
    try:
        # GStreamer ì´ˆê¸°í™”
        if not Gst.is_initialized():
            Gst.init(None)
        
        # ì¹´ë©”ë¼ ì°¾ê¸°
        video_device = find_working_camera()
        
        # ì¹´ë©”ë¼ ì´ˆê¸°í™” (ë‚®ì€ í•´ìƒë„ë¡œ)
        cap = cv2.VideoCapture(video_device)
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 640)
        cap.set(cv2.CAP_PROP_FPS, 15)  # ë‚®ì€ FPS ì„¤ì •
        
        if not cap.isOpened():
            raise Exception("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        print("âœ“ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ")
        
        # ìµœì í™”ëœ ë””í…í„° ì´ˆê¸°í™”
        detector = OptimizedRKNNDetector()
        print("âœ“ ìµœì í™”ëœ ë””í…í„° ì´ˆê¸°í™” ì™„ë£Œ")
        
        # RTSP ì„œë²„ ì´ˆê¸°í™”
        gst_server = GStreamerRTSPServer(port=7200, mount_point="/test")
        if not gst_server.start_server():
            raise Exception("RTSP ì„œë²„ ì‹œì‘ ì‹¤íŒ¨")
        print("âœ“ ìµœì í™”ëœ RTSP ì„œë²„ ì‹œì‘ ì™„ë£Œ")
        
        print(f"\nğŸ¥ ìŠ¤íŠ¸ë¦¬ë° URL: {gst_server.get_rtsp_url()}")
        print("ğŸš€ ìµœì í™”ëœ ì²˜ë¦¬ ì‹œì‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")
        
        frame_count = 0
        start_time = time.time()
        
        while True:
            ret, frame = cap.read()
            if not ret:
                time.sleep(0.01)
                continue
            
            # í”„ë ˆì„ ì²˜ë¦¬
            processed_frame = detector.detect(frame)
            
            # RTSP ìŠ¤íŠ¸ë¦¬ë°
            gst_server.push_frame(processed_frame)
            
            # í†µê³„ (100í”„ë ˆì„ë§ˆë‹¤)
            frame_count += 1
            if frame_count % 100 == 0:
                elapsed = time.time() - start_time
                fps = frame_count / elapsed
                print(f"ğŸ“Š ì „ì²´ í†µê³„ - í‰ê·  FPS: {fps:.1f}, ì´ í”„ë ˆì„: {frame_count}")
                start_time = time.time()
                frame_count = 0
            
            # ì§§ì€ ëŒ€ê¸°
            time.sleep(0.001)
    
    except KeyboardInterrupt:
        print("\nì¢…ë£Œ ì‹ í˜¸ ë°›ìŒ...")
    except Exception as e:
        print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc()
    finally:
        print("ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘...")
        
        if cap and cap.isOpened():
            cap.release()
            print("âœ“ ì¹´ë©”ë¼ í•´ì œ")
        
        if gst_server:
            gst_server.stop_server()
            print("âœ“ RTSP ì„œë²„ ì¤‘ì§€")
        
        if detector:
            del detector
            print("âœ“ ë””í…í„° ì •ë¦¬")
        
        print("âœ… ìµœì í™”ëœ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì™„ë£Œ")

if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print(f"ë©”ì¸ í•¨ìˆ˜ ì˜¤ë¥˜: {e}")
        traceback.print_exc()
