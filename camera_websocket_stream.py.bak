#!/usr/bin/env python3
"""
ğŸš€ WebSocket ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°
- WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì´ë¯¸ì§€ ì „ì†¡
- Base64 ì¸ì½”ë”©ìœ¼ë¡œ ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤ì‹œê°„ í‘œì‹œ
- ì§€ì—°ì‹œê°„ ìµœì†Œí™”
"""

import cv2
import asyncio
import websockets
import json
import base64
import threading
import time
import numpy as np
from rknnlite.api import RKNNLite as RKNN
import traceback

def find_working_camera():
    """ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ ì°¾ê¸°"""
    for i in range(12):
        device = f'/dev/video{i}'
        try:
            cap = cv2.VideoCapture(device)
            if cap.isOpened():
                ret, frame = cap.read()
                cap.release()
                if ret and frame is not None:
                    print(f"âœ“ ì¹´ë©”ë¼ ë°œê²¬: {device}")
                    return device
        except:
            continue
    raise Exception("ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

class WebSocketRKNNDetector:
    """WebSocketìš© RKNN ë””í…í„°"""
    def __init__(self, model_path='/home/spcwtech/yolo5n_fish-rk3566.rknn'):
        print("ğŸš€ WebSocket RKNN ë””í…í„° ì´ˆê¸°í™”...")
        
        self.rknn = RKNN()
        ret = self.rknn.load_rknn(model_path)
        if ret != 0:
            raise Exception('RKNN ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨')
        
        ret = self.rknn.init_runtime()
        if ret != 0:
            raise Exception('RKNN ëŸ°íƒ€ì„ ì´ˆê¸°í™” ì‹¤íŒ¨')
        
        self.input_size = 640
        self.frame_skip = 3  # ë§¤ 3ë²ˆì§¸ í”„ë ˆì„ë§Œ ì²˜ë¦¬
        self.frame_counter = 0
        self.last_detections = []
        
        print("âœ“ WebSocket ë””í…í„° ì´ˆê¸°í™” ì™„ë£Œ")
    
    def letterbox(self, img, new_shape=(640, 640)):
        """ë¹ ë¥¸ ë¦¬ì‚¬ì´ì¦ˆ"""
        return cv2.resize(img, new_shape)
    
    def detect(self, frame):
        """ë¹ ë¥¸ ê°ì§€"""
        try:
            self.frame_counter += 1
            if self.frame_counter % self.frame_skip != 0:
                return self.draw_cached_detections(frame)
            
            # ì „ì²˜ë¦¬
            input_frame = self.letterbox(frame, (self.input_size, self.input_size))
            input_frame = np.expand_dims(input_frame, axis=0)
            
            # RKNN ì¶”ë¡ 
            outputs = self.rknn.inference(inputs=[input_frame])
            
            # í›„ì²˜ë¦¬
            detections = self.decode_predictions(outputs)
            self.last_detections = detections
            
            return self.draw_detections(frame, detections)
            
        except Exception as e:
            return frame
    
    def decode_predictions(self, outputs, conf_thres=0.5):
        """ê°„ë‹¨í•œ ë””ì½”ë”©"""
        predictions = []
        try:
            for detection in outputs[0]:
                if len(detection) >= 6:
                    confidence = float(detection[4])
                    if confidence > conf_thres:
                        x, y, w, h = detection[:4]
                        class_id = int(detection[5])
                        predictions.append([x, y, w, h, confidence, class_id])
        except:
            pass
        return predictions
    
    def draw_cached_detections(self, frame):
        return self.draw_detections(frame, self.last_detections)
    
    def draw_detections(self, frame, detections):
        for det in detections:
            try:
                x, y, w, h, conf, class_id = det
                x1 = int(x - w/2)
                y1 = int(y - h/2)
                x2 = int(x + w/2)
                y2 = int(y + h/2)
                
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                cv2.putText(frame, f'{conf:.2f}', (x1, y1-10), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)
            except:
                continue
        return frame

class WebSocketStreamer:
    """WebSocket ìŠ¤íŠ¸ë¦¬ë¨¸"""
    def __init__(self):
        self.clients = set()
        self.current_frame = None
        self.running = False
    
    async def register_client(self, websocket, path):
        """í´ë¼ì´ì–¸íŠ¸ ë“±ë¡"""
        self.clients.add(websocket)
        print(f"ğŸ“± í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨: {len(self.clients)}ëª…")
        try:
            await websocket.wait_closed()
        finally:
            self.clients.remove(websocket)
            print(f"ğŸ“± í´ë¼ì´ì–¸íŠ¸ ì—°ê²° í•´ì œ: {len(self.clients)}ëª…")
    
    async def broadcast_frame(self):
        """í”„ë ˆì„ ë¸Œë¡œë“œìºìŠ¤íŠ¸"""
        while self.running:
            if self.current_frame is not None and self.clients:
                try:
                    # JPEG ì¸ì½”ë”©
                    ret, jpeg = cv2.imencode('.jpg', self.current_frame, 
                                           [cv2.IMWRITE_JPEG_QUALITY, 90])
                    if ret:
                        # Base64 ì¸ì½”ë”©
                        base64_data = base64.b64encode(jpeg.tobytes()).decode('utf-8')
                        
                        # JSON ë©”ì‹œì§€ ìƒì„±
                        message = json.dumps({
                            'type': 'frame',
                            'data': base64_data,
                            'timestamp': time.time()
                        })
                        
                        # ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡
                        disconnected = set()
                        for client in self.clients.copy():
                            try:
                                await client.send(message)
                            except:
                                disconnected.add(client)
                        
                        # ì—°ê²° ëŠì–´ì§„ í´ë¼ì´ì–¸íŠ¸ ì œê±°
                        self.clients -= disconnected
                
                except Exception as e:
                    print(f"ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì˜¤ë¥˜: {e}")
            
            await asyncio.sleep(0.033)  # ~30 FPS
    
    def set_frame(self, frame):
        """í”„ë ˆì„ ì„¤ì •"""
        self.current_frame = frame
    
    def start(self, host='0.0.0.0', port=8765):
        """WebSocket ì„œë²„ ì‹œì‘"""
        self.running = True
        
        # HTML í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        html_content = self.create_html_client()
        with open('/home/spcwtech/websocket_viewer.html', 'w') as f:
            f.write(html_content)
        
        # WebSocket ì„œë²„ ì‹œì‘
        return websockets.serve(self.register_client, host, port)
    
    def create_html_client(self):
        """HTML í´ë¼ì´ì–¸íŠ¸ ìƒì„±"""
        return """
<!DOCTYPE html>
<html>
<head>
    <title>ğŸš€ WebSocket ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼</title>
    <style>
        body { 
            background: #000; 
            color: #0f0; 
            text-align: center; 
            font-family: Arial; 
            margin: 0; 
            padding: 20px;
        }
        #stream { 
            max-width: 90%; 
            height: auto; 
            border: 2px solid #0f0; 
            border-radius: 10px;
        }
        h1 { color: #0f0; text-shadow: 0 0 10px #0f0; }
        #status { 
            color: #ff0; 
            font-size: 18px; 
            margin: 20px 0; 
        }
        #fps { 
            color: #0ff; 
            font-size: 16px; 
        }
    </style>
</head>
<body>
    <h1>ğŸš€ WebSocket ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼</h1>
    <div id="status">ì—°ê²° ì¤‘...</div>
    <div id="fps">FPS: --</div>
    <img id="stream" src="" alt="Camera Stream">
    
    <script>
        const ws = new WebSocket('ws://spcwtech.mooo.com:8765');
        const img = document.getElementById('stream');
        const status = document.getElementById('status');
        const fps = document.getElementById('fps');
        
        let frameCount = 0;
        let lastTime = Date.now();
        
        ws.onopen = function() {
            status.textContent = 'ğŸŸ¢ ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°';
            status.style.color = '#0f0';
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'frame') {
                img.src = 'data:image/jpeg;base64,' + data.data;
                
                // FPS ê³„ì‚°
                frameCount++;
                const now = Date.now();
                if (now - lastTime > 1000) {
                    const currentFps = (frameCount * 1000 / (now - lastTime)).toFixed(1);
                    fps.textContent = `FPS: ${currentFps}`;
                    frameCount = 0;
                    lastTime = now;
                }
            }
        };
        
        ws.onclose = function() {
            status.textContent = 'ğŸ”´ ì—°ê²° ëŠì–´ì§';
            status.style.color = '#f00';
        };
        
        ws.onerror = function(error) {
            status.textContent = 'âŒ ì—°ê²° ì˜¤ë¥˜';
            status.style.color = '#f00';
        };
    </script>
</body>
</html>
        """
    
    def stop(self):
        """ì„œë²„ ì¤‘ì§€"""
        self.running = False

async def camera_loop(streamer, detector):
    """ì¹´ë©”ë¼ ë£¨í”„"""
    try:
        video_device = find_working_camera()
        cap = cv2.VideoCapture(video_device)
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
        cap.set(cv2.CAP_PROP_FPS, 30)
        cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
        
        if not cap.isOpened():
            raise Exception("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        print("âœ“ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ")
        
        frame_count = 0
        start_time = time.time()
        
        while streamer.running:
            ret, frame = cap.read()
            if not ret:
                await asyncio.sleep(0.01)
                continue
            
            # ê°ì§€ ì²˜ë¦¬
            processed_frame = detector.detect(frame)
            
            # FPS ê³„ì‚°
            frame_count += 1
            if frame_count % 60 == 0:
                elapsed = time.time() - start_time
                fps = frame_count / elapsed
                print(f"ğŸš€ ì¹´ë©”ë¼ FPS: {fps:.1f}")
                start_time = time.time()
                frame_count = 0
            
            # ìŠ¤íŠ¸ë¦¬ë¨¸ì— í”„ë ˆì„ ì„¤ì •
            streamer.set_frame(processed_frame)
            
            await asyncio.sleep(0.01)
    
    except Exception as e:
        print(f"ì¹´ë©”ë¼ ë£¨í”„ ì˜¤ë¥˜: {e}")
        traceback.print_exc()
    finally:
        if cap and cap.isOpened():
            cap.release()

async def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print("ğŸš€ WebSocket ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘")
    
    try:
        # ë””í…í„° ì´ˆê¸°í™”
        detector = WebSocketRKNNDetector()
        
        # ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ˆê¸°í™”
        streamer = WebSocketStreamer()
        
        # WebSocket ì„œë²„ ì‹œì‘
        server = await streamer.start(host='0.0.0.0', port=8765)
        
        print("âœ… WebSocket ì„œë²„ ì‹œì‘ë¨:")
        print(f"   ğŸŒ ë·°ì–´: file:///home/spcwtech/websocket_viewer.html")
        print(f"   ğŸ”Œ WebSocket: ws://spcwtech.mooo.com:8765")
        print("\nğŸš€ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")
        
        # ë³‘ë ¬ ì‹¤í–‰
        await asyncio.gather(
            camera_loop(streamer, detector),
            streamer.broadcast_frame()
        )
    
    except KeyboardInterrupt:
        print("\nì¢…ë£Œ ì‹ í˜¸ ë°›ìŒ...")
    except Exception as e:
        print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc()
    finally:
        if 'streamer' in locals():
            streamer.stop()
        if 'detector' in locals():
            try:
                detector.rknn.release()
            except:
                pass
        print("âœ… WebSocket ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ì™„ë£Œ")

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except Exception as e:
        print(f"ë©”ì¸ í•¨ìˆ˜ ì˜¤ë¥˜: {e}")
        traceback.print_exc()
