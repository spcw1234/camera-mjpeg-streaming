#!/usr/bin/env python3
"""
ğŸš€ FFmpeg RTMP ì €ì§€ì—° ìŠ¤íŠ¸ë¦¬ë°
- FFmpeg íŒŒì´í”„ë¥¼ í†µí•œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°
- RTMP ì„œë²„ë¡œ ì €ì§€ì—° ì „ì†¡
- VLC, OBS ë“±ì—ì„œ ë°”ë¡œ ì‹œì²­ ê°€ëŠ¥
"""

import cv2
import subprocess
import threading
import time
import numpy as np
from rknnlite.api import RKNNLite as RKNN
import traceback
import signal
import sys

def find_working_camera():
    """ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ ì°¾ê¸°"""
    for i in range(12):
        device = f'/dev/video{i}'
        try:
            cap = cv2.VideoCapture(device)
            if cap.isOpened():
                ret, frame = cap.read()
                cap.release()
                if ret and frame is not None:
                    print(f"âœ“ ì¹´ë©”ë¼ ë°œê²¬: {device}")
                    return device
        except:
            continue
    raise Exception("ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

class FFmpegRKNNDetector:
    """FFmpegìš© RKNN ë””í…í„°"""
    def __init__(self, model_path='/home/spcwtech/yolo5n_fish-rk3566.rknn'):
        print("ğŸš€ FFmpeg RKNN ë””í…í„° ì´ˆê¸°í™”...")
        
        self.rknn = RKNN()
        ret = self.rknn.load_rknn(model_path)
        if ret != 0:
            raise Exception('RKNN ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨')
        
        ret = self.rknn.init_runtime()
        if ret != 0:
            raise Exception('RKNN ëŸ°íƒ€ì„ ì´ˆê¸°í™” ì‹¤íŒ¨')
        
        self.input_size = 640
        self.frame_skip = 2  # ë§¤ 2ë²ˆì§¸ í”„ë ˆì„ë§Œ ì²˜ë¦¬
        self.frame_counter = 0
        self.last_detections = []
        
        print("âœ“ FFmpeg ë””í…í„° ì´ˆê¸°í™” ì™„ë£Œ")
    
    def letterbox(self, img, new_shape=(640, 640)):
        """ë¹ ë¥¸ ë¦¬ì‚¬ì´ì¦ˆ"""
        return cv2.resize(img, new_shape)
    
    def detect(self, frame):
        """ë¹ ë¥¸ ê°ì§€"""
        try:
            self.frame_counter += 1
            if self.frame_counter % self.frame_skip != 0:
                return self.draw_cached_detections(frame)
            
            # ì „ì²˜ë¦¬
            input_frame = self.letterbox(frame, (self.input_size, self.input_size))
            input_frame = np.expand_dims(input_frame, axis=0)
            
            # RKNN ì¶”ë¡ 
            outputs = self.rknn.inference(inputs=[input_frame])
            
            # í›„ì²˜ë¦¬
            detections = self.decode_predictions(outputs)
            self.last_detections = detections
            
            return self.draw_detections(frame, detections)
            
        except Exception as e:
            return frame
    
    def decode_predictions(self, outputs, conf_thres=0.5):
        """ê°„ë‹¨í•œ ë””ì½”ë”©"""
        predictions = []
        try:
            for detection in outputs[0]:
                if len(detection) >= 6:
                    confidence = float(detection[4])
                    if confidence > conf_thres:
                        x, y, w, h = detection[:4]
                        class_id = int(detection[5])
                        predictions.append([x, y, w, h, confidence, class_id])
        except:
            pass
        return predictions
    
    def draw_cached_detections(self, frame):
        return self.draw_detections(frame, self.last_detections)
    
    def draw_detections(self, frame, detections):
        for det in detections:
            try:
                x, y, w, h, conf, class_id = det
                x1 = int(x - w/2)
                y1 = int(y - h/2)
                x2 = int(x + w/2)
                y2 = int(y + h/2)
                
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                cv2.putText(frame, f'{conf:.2f}', (x1, y1-10), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)
            except:
                continue
        return frame

class FFmpegStreamer:
    """FFmpeg ìŠ¤íŠ¸ë¦¬ë¨¸"""
    def __init__(self, output_url=None, width=640, height=480, fps=30):
        self.width = width
        self.height = height
        self.fps = fps
        self.ffmpeg_process = None
        self.running = False
        
        # ì¶œë ¥ URL ì„¤ì • (RTMP ë˜ëŠ” íŒŒì¼)
        if output_url is None:
            # ë¡œì»¬ RTMP ì„œë²„ê°€ ì—†ìœ¼ë©´ íŒŒì¼ë¡œ ì €ì¥
            self.output_url = f"/home/spcwtech/live_stream_{int(time.time())}.mp4"
            print(f"ğŸ“ íŒŒì¼ë¡œ ì €ì¥: {self.output_url}")
        else:
            self.output_url = output_url
            print(f"ğŸ“¡ RTMP ìŠ¤íŠ¸ë¦¬ë°: {self.output_url}")
        
        self.start_ffmpeg()
    
    def start_ffmpeg(self):
        """FFmpeg í”„ë¡œì„¸ìŠ¤ ì‹œì‘"""
        try:
            # FFmpeg ëª…ë ¹ì–´ êµ¬ì„±
            cmd = [
                'ffmpeg',
                '-y',  # ë®ì–´ì“°ê¸°
                '-f', 'rawvideo',
                '-vcodec', 'rawvideo',
                '-pix_fmt', 'bgr24',
                '-s', f'{self.width}x{self.height}',
                '-r', str(self.fps),
                '-i', '-',  # stdinì—ì„œ ì…ë ¥
                '-c:v', 'libx264',
                '-preset', 'ultrafast',
                '-tune', 'zerolatency',
                '-crf', '23',
                '-maxrate', '1000k',
                '-bufsize', '2000k',
                '-g', '30',  # í‚¤í”„ë ˆì„ ê°„ê²©
                '-f', 'flv' if 'rtmp://' in self.output_url else 'mp4',
                self.output_url
            ]
            
            print(f"ğŸš€ FFmpeg ëª…ë ¹ì–´: {' '.join(cmd)}")
            
            # FFmpeg í”„ë¡œì„¸ìŠ¤ ì‹œì‘
            self.ffmpeg_process = subprocess.Popen(
                cmd,
                stdin=subprocess.PIPE,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE
            )
            
            self.running = True
            print("âœ“ FFmpeg í”„ë¡œì„¸ìŠ¤ ì‹œì‘ë¨")
            
            # stderr ëª¨ë‹ˆí„°ë§ ìŠ¤ë ˆë“œ
            self.stderr_thread = threading.Thread(target=self.monitor_ffmpeg, daemon=True)
            self.stderr_thread.start()
            
        except Exception as e:
            print(f"FFmpeg ì‹œì‘ ì‹¤íŒ¨: {e}")
            raise
    
    def monitor_ffmpeg(self):
        """FFmpeg stderr ëª¨ë‹ˆí„°ë§"""
        try:
            while self.running and self.ffmpeg_process:
                line = self.ffmpeg_process.stderr.readline()
                if line:
                    line_str = line.decode('utf-8', errors='ignore').strip()
                    if 'frame=' in line_str:  # í”„ë ˆì„ ì •ë³´ë§Œ ì¶œë ¥
                        print(f"ğŸ“¹ {line_str}")
        except Exception as e:
            print(f"FFmpeg ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: {e}")
    
    def write_frame(self, frame):
        """í”„ë ˆì„ì„ FFmpegì— ì „ì†¡"""
        try:
            if self.ffmpeg_process and self.running:
                # í¬ê¸° ì¡°ì •
                if frame.shape[:2] != (self.height, self.width):
                    frame = cv2.resize(frame, (self.width, self.height))
                
                # FFmpeg stdinì— ì“°ê¸°
                self.ffmpeg_process.stdin.write(frame.tobytes())
                return True
        except Exception as e:
            print(f"í”„ë ˆì„ ì“°ê¸° ì˜¤ë¥˜: {e}")
            return False
        return False
    
    def stop(self):
        """FFmpeg í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€"""
        self.running = False
        
        if self.ffmpeg_process:
            try:
                # stdin ë‹«ê¸°
                self.ffmpeg_process.stdin.close()
                
                # í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
                self.ffmpeg_process.wait(timeout=5)
                print("âœ“ FFmpeg í”„ë¡œì„¸ìŠ¤ ì •ìƒ ì¢…ë£Œ")
            except subprocess.TimeoutExpired:
                # ê°•ì œ ì¢…ë£Œ
                self.ffmpeg_process.terminate()
                try:
                    self.ffmpeg_process.wait(timeout=2)
                    print("âœ“ FFmpeg í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ")
                except subprocess.TimeoutExpired:
                    self.ffmpeg_process.kill()
                    print("âœ“ FFmpeg í”„ë¡œì„¸ìŠ¤ ê°•ì œ í‚¬")

def signal_handler(sig, frame):
    """ì‹œê·¸ë„ í•¸ë“¤ëŸ¬"""
    print("\nì¢…ë£Œ ì‹ í˜¸ ë°›ìŒ...")
    sys.exit(0)

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print("ğŸš€ FFmpeg ì €ì§€ì—° ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘")
    
    # ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ë“±ë¡
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    cap = None
    detector = None
    streamer = None
    
    try:
        # ì¹´ë©”ë¼ ì´ˆê¸°í™”
        video_device = find_working_camera()
        cap = cv2.VideoCapture(video_device)
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
        cap.set(cv2.CAP_PROP_FPS, 30)
        cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
        
        if not cap.isOpened():
            raise Exception("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        print("âœ“ ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ")
        
        # ë””í…í„° ì´ˆê¸°í™”
        detector = FFmpegRKNNDetector()
        
        # FFmpeg ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ˆê¸°í™”
        # RTMP ì„œë²„ê°€ ìˆë‹¤ë©´ URL ë³€ê²½
        # rtmp_url = "rtmp://spcwtech.mooo.com/live/stream"
        streamer = FFmpegStreamer(output_url=None, width=640, height=480, fps=30)
        
        print("\nğŸš€ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")
        print("ğŸ“¹ FFmpegë¡œ ì‹¤ì‹œê°„ ì¸ì½”ë”© ì¤‘...")
        
        frame_count = 0
        start_time = time.time()
        
        while True:
            ret, frame = cap.read()
            if not ret:
                time.sleep(0.01)
                continue
            
            # ê°ì§€ ì²˜ë¦¬
            processed_frame = detector.detect(frame)
            
            # FFmpegì— í”„ë ˆì„ ì „ì†¡
            if not streamer.write_frame(processed_frame):
                print("âš ï¸ FFmpeg ì“°ê¸° ì‹¤íŒ¨")
                break
            
            # FPS ê³„ì‚°
            frame_count += 1
            if frame_count % 60 == 0:
                elapsed = time.time() - start_time
                fps = frame_count / elapsed
                print(f"ğŸš€ ì²˜ë¦¬ FPS: {fps:.1f}")
                start_time = time.time()
                frame_count = 0
            
            time.sleep(0.01)  # CPU ì‚¬ìš©ëŸ‰ ì¡°ì ˆ
    
    except KeyboardInterrupt:
        print("\nì¢…ë£Œ ì‹ í˜¸ ë°›ìŒ...")
    except Exception as e:
        print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc()
    finally:
        print("ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘...")
        
        if cap and cap.isOpened():
            cap.release()
            print("âœ“ ì¹´ë©”ë¼ í•´ì œ")
        
        if streamer:
            streamer.stop()
            print("âœ“ FFmpeg ìŠ¤íŠ¸ë¦¬ë¨¸ ì¢…ë£Œ")
        
        if detector:
            try:
                detector.rknn.release()
            except:
                pass
            print("âœ“ ë””í…í„° ì •ë¦¬")
        
        print("âœ… FFmpeg ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ì™„ë£Œ")

if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print(f"ë©”ì¸ í•¨ìˆ˜ ì˜¤ë¥˜: {e}")
        traceback.print_exc()
