#!/usr/bin/env python3
"""
ğŸš€ ì´ˆê³ ì† ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° í”„ë¡œê·¸ë¨
- RKNN ì¶”ë¡  ìµœì í™”
- DeepSORT ì™„ì „ ì œê±°
- í”„ë ˆì„ ìŠ¤í‚µ í™œì„±í™”
- ìµœì†Œ ì§€ì—° GStreamer íŒŒì´í”„ë¼ì¸
"""

import cv2
import gi
import threading
import time
import numpy as np
import traceback
from rknnlite.api import RKNNLite as RKNN

gi.require_version('Gst', '1.0')
gi.require_version('GstRtspServer', '1.0')
from gi.repository import Gst, GstRtspServer, GLib

def find_working_camera():
    """ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ ì°¾ê¸°"""
    for i in range(12):
        device = f'/dev/video{i}'
        try:
            cap = cv2.VideoCapture(device)
            if cap.isOpened():
                ret, frame = cap.read()
                cap.release()
                if ret and frame is not None:
                    print(f"âœ“ ì¹´ë©”ë¼ ë°œê²¬: {device}")
                    return device
        except:
            continue
    raise Exception("ì‘ë™í•˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

class FastGStreamerRTSPServer:
    """ì´ˆê³ ì† GStreamer RTSP ì„œë²„"""
    def __init__(self, port=7200, mount_point="/test"):
        self.port = port
        self.mount_point = mount_point
        self.server = None
        self.factory = None
        self.mainloop = None
        self.running = False
        self.appsrc = None
        self.frame_count = 0
        
        if not Gst.is_initialized():
            Gst.init(None)
        print(f"ğŸš€ ì´ˆê³ ì† RTSP ì„œë²„ ì´ˆê¸°í™” - Port: {port}")
    
    def create_pipeline(self):
        """ì´ˆì €ì§€ì—° íŒŒì´í”„ë¼ì¸"""
        return (
            "( appsrc name=source is-live=true block=false format=GST_FORMAT_TIME "
            "do-timestamp=true max-buffers=1 drop=true "
            "caps=video/x-raw,format=BGR,width=640,height=480,framerate=30/1 ! "
            "videoconvert ! video/x-raw,format=I420 ! "
            "x264enc speed-preset=ultrafast tune=zerolatency bitrate=500 threads=1 "
            "key-int-max=5 bframes=0 ! "
            "rtph264pay config-interval=1 mtu=1200 name=pay0 pt=96 )"
        )
    
    def start_server(self):
        """ì„œë²„ ì‹œì‘"""
        try:
            self.server = GstRtspServer.RTSPServer()
            self.server.set_service(str(self.port))
            
            self.factory = GstRtspServer.RTSPMediaFactory()
            self.factory.set_launch(self.create_pipeline())
            self.factory.set_shared(True)
            self.factory.connect("media-configure", self.on_media_configure)
            
            mount_points = self.server.get_mount_points()
            mount_points.add_factory(self.mount_point, self.factory)
            self.server.attach(None)
            
            # GLib ë£¨í”„ ì‹œì‘
            def glib_loop():
                self.mainloop = GLib.MainLoop()
                self.mainloop.run()
            
            self.glib_thread = threading.Thread(target=glib_loop, daemon=True)
            self.glib_thread.start()
            
            self.running = True
            print(f"âœ“ ì´ˆê³ ì† RTSP ì„œë²„ ì‹œì‘ - rtsp://spcwtech.mooo.com:{self.port}{self.mount_point}")
            return True
            
        except Exception as e:
            print(f"ì„œë²„ ì‹œì‘ ì‹¤íŒ¨: {e}")
            return False
    
    def on_media_configure(self, factory, media):
        """ë¯¸ë””ì–´ êµ¬ì„±"""
        try:
            element = media.get_element()
            if element:
                self.appsrc = element.get_by_name("source")
                if self.appsrc:
                    # ì´ˆê³ ì† ì„¤ì •
                    self.appsrc.set_property("is-live", True)
                    self.appsrc.set_property("block", False)
                    self.appsrc.set_property("max-buffers", 1)
                    self.appsrc.set_property("drop", True)
                    
                    caps = Gst.Caps.from_string("video/x-raw,format=BGR,width=640,height=480,framerate=30/1")
                    self.appsrc.set_property("caps", caps)
                    print("âœ“ ì´ˆê³ ì† appsrc êµ¬ì„± ì™„ë£Œ")
        except Exception as e:
            print(f"ë¯¸ë””ì–´ êµ¬ì„± ì˜¤ë¥˜: {e}")
    
    def push_frame(self, frame):
        """ì´ˆê³ ì† í”„ë ˆì„ í‘¸ì‹œ"""
        try:
            if not self.running or self.appsrc is None:
                return False
            
            # í¬ê¸° ì¡°ì • (í•„ìš”ì‹œ)
            if frame.shape[:2] != (480, 640):
                frame = cv2.resize(frame, (640, 480))
            
            # ë°ì´í„° ë³€í™˜
            data = frame.tobytes()
            buf = Gst.Buffer.new_allocate(None, len(data), None)
            buf.fill(0, data)
            
            # íƒ€ì„ìŠ¤íƒ¬í”„ (ê°„ë‹¨)
            self.frame_count += 1
            buf.pts = self.frame_count * (Gst.SECOND // 30)  # 30fps
            buf.duration = Gst.SECOND // 30
            
            # í‘¸ì‹œ
            retval = self.appsrc.emit('push-buffer', buf)
            return retval == Gst.FlowReturn.OK
                
        except:
            return False
    
    def stop_server(self):
        """ì„œë²„ ì¤‘ì§€"""
        if self.running:
            self.running = False
            if self.appsrc:
                try:
                    self.appsrc.emit("end-of-stream")
                except:
                    pass
            if self.mainloop:
                try:
                    self.mainloop.quit()
                except:
                    pass
    
    def get_rtsp_url(self):
        return f"rtsp://spcwtech.mooo.com:{self.port}{self.mount_point}"

class UltraFastRKNNDetector:
    """ì´ˆê³ ì† RKNN ë””í…í„°"""
    def __init__(self, model_path='/home/spcwtech/yolo5n_fish-rk3566.rknn'):
        print("ğŸš€ ì´ˆê³ ì† RKNN ë””í…í„° ì´ˆê¸°í™”...")
        
        # RKNN ëª¨ë¸ ë¡œë“œ
        self.rknn = RKNN()
        ret = self.rknn.load_rknn(model_path)
        if ret != 0:
            raise Exception('RKNN ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨')
        
        ret = self.rknn.init_runtime()
        if ret != 0:
            raise Exception('RKNN ëŸ°íƒ€ì„ ì´ˆê¸°í™” ì‹¤íŒ¨')
        
        self.input_size = 640
        
        # ğŸš€ ê·¹í•œ ìµœì í™” ì„¤ì •
        self.frame_skip = 5  # ë§¤ 5ë²ˆì§¸ í”„ë ˆì„ë§Œ ì²˜ë¦¬
        self.frame_counter = 0
        self.last_detections = []  # ì´ì „ ê°ì§€ ê²°ê³¼ ì¬ì‚¬ìš©
        
        print("âœ“ ì´ˆê³ ì† ë””í…í„° ì´ˆê¸°í™” ì™„ë£Œ")
    
    def letterbox(self, img, new_shape=(640, 640)):
        """ë¹ ë¥¸ ë¦¬ì‚¬ì´ì¦ˆ"""
        return cv2.resize(img, new_shape)
    
    def decode_predictions(self, output, conf_thres=0.5):
        """ë¹ ë¥¸ ë””ì½”ë”©"""
        predictions = []
        try:
            # ê°„ë‹¨í•œ ë””ì½”ë”© (ì†ë„ ìš°ì„ )
            for detection in output[0]:
                if len(detection) >= 6:
                    confidence = float(detection[4])
                    if confidence > conf_thres:
                        x, y, w, h = detection[:4]
                        class_id = int(detection[5])
                        predictions.append([x, y, w, h, confidence, class_id])
        except:
            pass
        return predictions
    
    def detect(self, frame):
        """ì´ˆê³ ì† ê°ì§€"""
        try:
            # ğŸš€ í”„ë ˆì„ ìŠ¤í‚µìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ
            self.frame_counter += 1
            if self.frame_counter % self.frame_skip != 0:
                # ì´ì „ ê²°ê³¼ ì¬ì‚¬ìš©
                return self.draw_cached_detections(frame)
            
            # ì „ì²˜ë¦¬ (ìµœì†Œí™”)
            input_frame = self.letterbox(frame, (self.input_size, self.input_size))
            input_frame = np.expand_dims(input_frame, axis=0)
            
            # RKNN ì¶”ë¡ 
            outputs = self.rknn.inference(inputs=[input_frame])
            
            # í›„ì²˜ë¦¬ (ìµœì†Œí™”)
            predictions = self.decode_predictions(outputs, conf_thres=0.5)
            
            # ê²°ê³¼ ìºì‹œ
            self.last_detections = predictions
            
            # ê·¸ë¦¬ê¸°
            return self.draw_detections(frame, predictions)
            
        except Exception as e:
            print(f"ê°ì§€ ì˜¤ë¥˜: {e}")
            return frame
    
    def draw_cached_detections(self, frame):
        """ìºì‹œëœ ê°ì§€ ê²°ê³¼ ê·¸ë¦¬ê¸°"""
        return self.draw_detections(frame, self.last_detections)
    
    def draw_detections(self, frame, detections):
        """ê°„ë‹¨í•œ ê°ì§€ ê²°ê³¼ ê·¸ë¦¬ê¸°"""
        for det in detections:
            try:
                x, y, w, h, conf, class_id = det
                x1 = int(x - w/2)
                y1 = int(y - h/2)
                x2 = int(x + w/2)
                y2 = int(y + h/2)
                
                # ê°„ë‹¨í•œ ë°•ìŠ¤ë§Œ ê·¸ë¦¬ê¸°
                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                cv2.putText(frame, f'{conf:.2f}', (x1, y1-10), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)
            except:
                continue
        
        return frame

def main():
    """ì´ˆê³ ì† ë©”ì¸ í•¨ìˆ˜"""
    print("ğŸš€ ì´ˆê³ ì† ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘")
    
    cap = None
    detector = None
    gst_server = None
    
    try:
        # GStreamer ì´ˆê¸°í™”
        if not Gst.is_initialized():
            Gst.init(None)
        
        # ì¹´ë©”ë¼ ì°¾ê¸°
        video_device = find_working_camera()
        
        # ì¹´ë©”ë¼ ì´ˆê¸°í™” (ê³ ì† ì„¤ì •)
        cap = cv2.VideoCapture(video_device)
        cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
        cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
        cap.set(cv2.CAP_PROP_FPS, 30)
        cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)  # ë²„í¼ ìµœì†Œí™”
        
        if not cap.isOpened():
            raise Exception("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        print("âœ“ ê³ ì† ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ")
        
        # ì´ˆê³ ì† ë””í…í„° ì´ˆê¸°í™”
        detector = UltraFastRKNNDetector()
        
        # ì´ˆê³ ì† RTSP ì„œë²„ ì´ˆê¸°í™”
        gst_server = FastGStreamerRTSPServer(port=7200, mount_point="/test")
        if not gst_server.start_server():
            raise Exception("RTSP ì„œë²„ ì‹œì‘ ì‹¤íŒ¨")
        
        print(f"\nğŸ¥ ì´ˆê³ ì† ìŠ¤íŠ¸ë¦¬ë° URL: {gst_server.get_rtsp_url()}")
        print("ğŸš€ ì´ˆê³ ì† ì²˜ë¦¬ ì‹œì‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")
        
        frame_count = 0
        start_time = time.time()
        fps_counter = 0
        
        while True:
            # í”„ë ˆì„ ìº¡ì²˜
            ret, frame = cap.read()
            if not ret:
                time.sleep(0.001)
                continue
            
            # ì´ˆê³ ì† ì²˜ë¦¬
            processed_frame = detector.detect(frame)
            
            # ì´ˆê³ ì† ìŠ¤íŠ¸ë¦¬ë°
            gst_server.push_frame(processed_frame)
            
            # FPS ì¹´ìš´í„°
            fps_counter += 1
            if fps_counter % 30 == 0:
                elapsed = time.time() - start_time
                fps = fps_counter / elapsed
                print(f"ğŸš€ ì´ˆê³ ì† FPS: {fps:.1f}")
                
                # ë¦¬ì…‹
                start_time = time.time()
                fps_counter = 0
            
            # ìµœì†Œ ëŒ€ê¸°
            time.sleep(0.001)
    
    except KeyboardInterrupt:
        print("\nì¢…ë£Œ ì‹ í˜¸ ë°›ìŒ...")
    except Exception as e:
        print(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc()
    finally:
        print("ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘...")
        
        if cap and cap.isOpened():
            cap.release()
            print("âœ“ ì¹´ë©”ë¼ í•´ì œ")
        
        if gst_server:
            gst_server.stop_server()
            print("âœ“ RTSP ì„œë²„ ì¤‘ì§€")
        
        if detector:
            try:
                detector.rknn.release()
            except:
                pass
            print("âœ“ ë””í…í„° ì •ë¦¬")
        
        print("âœ… ì´ˆê³ ì† í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì™„ë£Œ")

if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print(f"ë©”ì¸ í•¨ìˆ˜ ì˜¤ë¥˜: {e}")
        traceback.print_exc()
